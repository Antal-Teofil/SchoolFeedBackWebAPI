<!DOCTYPE html>
<html>
  <head>
    <meta name="google-signin-client_id" content="499857664830-2bdarnf13t5g3j8t3e7pgv46it7tba1b.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <div id="g_id_onload"
         data-client_id="499857664830-2bdarnf13t5g3j8t3e7pgv46it7tba1b.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>

    <button id="get-evaluation">Get Evaluation</button>

    <script>
      async function handleCredentialResponse(response) {
        console.log("ID Token:", response.credential);

        try {
          const res = await fetch('http://localhost:7277/api/auth/google', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',  // important to receive cookies
            body: JSON.stringify({ IdToken: response.credential })
          });

          if (!res.ok) {
            const errorText = await res.text();
            alert("Login failed: " + errorText);
            return;
          }

          const data = await res.json();
          console.log("User data from backend:", data);
          alert(`Welcome ${data.email}, role: ${data.role}`);
        } catch (err) {
          console.error(err);
          alert("An error occurred during login");
        }
      }

      document.getElementById('get-evaluation').addEventListener('click', async () => {
        try {
          const res = await fetch('http://localhost:7277/api/evaluations/314983c0-344f-45da-9b91-b7f1a5a31fea', {
            method: 'PATCH',
            credentials: 'include', // send cookies automatically
          });

          if (!res.ok) {
            const errorText = await res.text();
            alert("Failed to get evaluation: " + errorText);
            return;
          }

          const evaluation = await res.json();
          console.log("Evaluation data:", evaluation);
          alert("Evaluation data received! Check console for details.");
        } catch (err) {
          console.error(err);
          alert("An error occurred while fetching the evaluation");
        }
      });
    </script>
  </body>
</html>
